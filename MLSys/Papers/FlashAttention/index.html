
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../LoRA/">
      
      
        <link rel="next" href="../LLaMA-Adapter/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>FlashAttention - 凉粥的学习笔记</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Serif SC";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/timeago.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#flash-attention" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="凉粥的学习笔记" class="md-header__button md-logo" aria-label="凉粥的学习笔记" data-md-component="logo">
      
  <img src="../../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            凉粥的学习笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              FlashAttention
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/ColdPorridge/notebook" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ColdPorridge/notebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        主页
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../OS/" class="md-tabs__link">
        OS
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../DB/" class="md-tabs__link">
        DB
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../Distributed%20System/" class="md-tabs__link">
        Distributed Systems
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link md-tabs__link--active">
        MLSys
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../DL%26ML/" class="md-tabs__link">
        DL&ML
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../Web/" class="md-tabs__link">
        杂
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="凉粥的学习笔记" class="md-nav__button md-logo" aria-label="凉粥的学习笔记" data-md-component="logo">
      
  <img src="../../../logo.png" alt="logo">

    </a>
    凉粥的学习笔记
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ColdPorridge/notebook" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ColdPorridge/notebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../..">主页</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          主页
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../OS/">OS</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          OS
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Storage stack
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Storage stack
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../OS/Storagestack/IO/" class="md-nav__link">
        几种常见的IO方式
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../DB/">DB</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          DB
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../Distributed%20System/">Distributed Systems</a>
          
            <label for="__nav_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Distributed Systems
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../Distributed%20System/%E5%89%91%E6%A1%A5%E5%88%86%E5%B8%83%E5%BC%8F/">剑桥分布式系统课程</a>
          
            <label for="__nav_4_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          剑桥分布式系统课程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Distributed%20System/%E5%89%91%E6%A1%A5%E5%88%86%E5%B8%83%E5%BC%8F/L1/" class="md-nav__link">
        1. Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Distributed%20System/%E5%89%91%E6%A1%A5%E5%88%86%E5%B8%83%E5%BC%8F/L2/" class="md-nav__link">
        2. Models of distributed systems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Distributed%20System/%E5%89%91%E6%A1%A5%E5%88%86%E5%B8%83%E5%BC%8F/L3/" class="md-nav__link">
        3. Time, clocks, and ordering of events
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Distributed%20System/%E5%89%91%E6%A1%A5%E5%88%86%E5%B8%83%E5%BC%8F/L4/" class="md-nav__link">
        4. Broadcast protocols and logical time
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">MLSys</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MLSys
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Papers</a>
          
            <label for="__nav_5_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Papers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../LoRA/" class="md-nav__link">
        LoRA
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          FlashAttention
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        FlashAttention
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#flash-attention" class="md-nav__link">
    Flash Attention
  </a>
  
    <nav class="md-nav" aria-label="Flash Attention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    1. Introduction
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation-modeling-longer-sqquences" class="md-nav__link">
    1.1 Motivation: Modeling Longer Sqquences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-method-summary" class="md-nav__link">
    1.2 Method Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-background" class="md-nav__link">
    1.3 Background
  </a>
  
    <nav class="md-nav" aria-label="1.3 Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu的存储层次" class="md-nav__link">
    GPU的存储层次：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    Performance characteristics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-fusion" class="md-nav__link">
    Kernel fusion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attention-的计算与瓶颈" class="md-nav__link">
    Attention 的计算与瓶颈
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#approximate-attention" class="md-nav__link">
    Approximate Attention
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-method" class="md-nav__link">
    2. Method
  </a>
  
    <nav class="md-nav" aria-label="2. Method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tiling" class="md-nav__link">
    Tiling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recomputation" class="md-nav__link">
    Recomputation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flashattention-2" class="md-nav__link">
    FlashAttention-2
  </a>
  
    <nav class="md-nav" aria-label="FlashAttention-2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-introduction_1" class="md-nav__link">
    1. Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-method_1" class="md-nav__link">
    2. Method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../LLaMA-Adapter/" class="md-nav__link">
        LLaMA-Adapter
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../CMU10414/">CMU 10-414/714</a>
          
            <label for="__nav_5_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          CMU 10-414/714
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CMU10414/basics/" class="md-nav__link">
        Deep learning basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CMU10414/AD/" class="md-nav__link">
        Automatic Differentiation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CMU10414/NN/" class="md-nav__link">
        Neural Network Abstraction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CMU10414/NN_impl/" class="md-nav__link">
        Neural Network Implementation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../CMU10414/GPU_acc/" class="md-nav__link">
        Hardware Acceleration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../FSDP/" class="md-nav__link">
        FSDP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../DL%26ML/">DL&ML</a>
          
            <label for="__nav_6">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          DL&ML
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../DL%26ML/Transformer/" class="md-nav__link">
        Transformer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../DL%26ML/GPT/" class="md-nav__link">
        GPT
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../DL%26ML/HELM/" class="md-nav__link">
        HELM
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../Web/">杂</a>
          
            <label for="__nav_7">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          杂
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
          浏览器内核
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          浏览器内核
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../Web/Browser%20Kernel/webview/" class="md-nav__link">
        WebView
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#flash-attention" class="md-nav__link">
    Flash Attention
  </a>
  
    <nav class="md-nav" aria-label="Flash Attention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    1. Introduction
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation-modeling-longer-sqquences" class="md-nav__link">
    1.1 Motivation: Modeling Longer Sqquences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-method-summary" class="md-nav__link">
    1.2 Method Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-background" class="md-nav__link">
    1.3 Background
  </a>
  
    <nav class="md-nav" aria-label="1.3 Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu的存储层次" class="md-nav__link">
    GPU的存储层次：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    Performance characteristics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-fusion" class="md-nav__link">
    Kernel fusion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attention-的计算与瓶颈" class="md-nav__link">
    Attention 的计算与瓶颈
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#approximate-attention" class="md-nav__link">
    Approximate Attention
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-method" class="md-nav__link">
    2. Method
  </a>
  
    <nav class="md-nav" aria-label="2. Method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tiling" class="md-nav__link">
    Tiling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recomputation" class="md-nav__link">
    Recomputation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flashattention-2" class="md-nav__link">
    FlashAttention-2
  </a>
  
    <nav class="md-nav" aria-label="FlashAttention-2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-introduction_1" class="md-nav__link">
    1. Introduction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-method_1" class="md-nav__link">
    2. Method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>FlashAttention</h1>

<h2 id="flash-attention">Flash Attention<a class="headerlink" href="#flash-attention" title="Permanent link">&para;</a></h2>
<p><a href="https://arxiv.org/pdf/2205.14135.pdf">FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness</a></p>
<h3 id="1-introduction">1. Introduction<a class="headerlink" href="#1-introduction" title="Permanent link">&para;</a></h3>
<h4 id="11-motivation-modeling-longer-sqquences">1.1 Motivation: Modeling Longer Sqquences<a class="headerlink" href="#11-motivation-modeling-longer-sqquences" title="Permanent link">&para;</a></h4>
<p>动机很简单，就是想要等接受比较长的序列作为泛Transformed架构的输入：</p>
<ul>
<li>
<p>NLP中：接收到更长的文本，可以理解书，戏剧...</p>
</li>
<li>
<p>CV中：可以接受更高分辨率的图像（ViT），更好的理解图像</p>
</li>
<li>
<p>时间序列，音频，视频：都是非常长的序列</p>
</li>
</ul>
<p><strong>Challenge: How to scale Transformers to longer sequences?</strong></p>
<p>Transformer的部分结构，这里以Encoder为例：</p>
<figure>
<p><img alt="Alt text" src="../assets/image-5.png" width="300" /></p>
</figure>
<ul>
<li>
<p>Attention在sequence变长时，计算的拓展性并不好</p>
</li>
<li>
<p>MLP 在sequence变长时，计算的拓展性还不错</p>
</li>
</ul>
<p>所以主要关注对Attention的优化</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p><figure markdown>
    <img alt="Alt text" src="../assets/image-3.png" />
</figure>
使用Megatron的方法训练，序列长度从2K-8K，训练时间显著降低</p>
<p>这里剧透一下用了Flash Attention之后的效果：
<figure markdown>
    <img alt="Alt text" src="../assets/image-4.png" />
</figure></p>
</div>
<h4 id="12-method-summary">1.2 Method Summary<a class="headerlink" href="#12-method-summary" title="Permanent link">&para;</a></h4>
<p>Tiling &amp; recomputation: 可以有效降低 GPU memory IO</p>
<p>一张图省流概括：
<img alt="Alt text" src="../assets/image-6.png" /></p>
<h4 id="13-background">1.3 Background<a class="headerlink" href="#13-background" title="Permanent link">&para;</a></h4>
<h5 id="gpu的存储层次">GPU的存储层次：<a class="headerlink" href="#gpu的存储层次" title="Permanent link">&para;</a></h5>
<p>A100 GPU 为例：</p>
<figure>
<p><img alt="Alt text" src="../assets/image-11.png" /></p>
</figure>
<ul>
<li>
<p>有 40-80GB 高带宽内存 (HBM)，带宽为 1.5-2.0TB/s</p>
</li>
<li>
<p>108 个流式多处理器（SMP）中的每个都有 192KB on-chip SRAM，带宽约为 19TB/s(似乎就是CUDA编程抽象中的shared memory)</p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">相关阅读</p>
<p><a href="https://horace.io/brrr_intro.html">Making Deep Learning Go Brrrr From First Principles</a></p>
</div>
<h5 id="performance-characteristics">Performance characteristics<a class="headerlink" href="#performance-characteristics" title="Permanent link">&para;</a></h5>
<p>GPU 有大量的线程来执行opertaion（也被成为 kernel）。每个kernel 将input从HBM load到寄存器和 SRAM，进行计算，然后将output写入 HBM。</p>
<p>根据计算和内存访问的平衡，operations 可分为compute-bound和memory-bound操作。这通常用arithmetic intensity来衡量，即 number of arithmetic operations per byte of memory access</p>
<ol>
<li>
<p>Compute-bound：operations持续时间取决于运算次数的多少，而访问 HBM 的时间要短得多。典型的例子是matrix multiply with large inner dimension, convolution with large number of channels.</p>
</li>
<li>
<p>Memory-bound: operations持续时间取决于内存访问次数，而计算耗时要少得多。这方面的例子包括大多数其他操作：elementwise（如activation、dropout）和reduction（如sum、softmax、batch norm、layer norm）。</p>
</li>
</ol>
<h5 id="kernel-fusion">Kernel fusion<a class="headerlink" href="#kernel-fusion" title="Permanent link">&para;</a></h5>
<p>加速Memory-bound operation 的最常见方法是 Kernel fusion：如果相同的input会连续经历多个operation，可以从 HBM 一次load输入，而不是为每个operation结束都将结果写入 HBM, 下个operation开始再load。编译器可以自动进行 Kernel fusion</p>
<p>但是，在模型训练的情况下，中间值仍然需要写入 HBM 以供backward计算梯度时使用，导致Kernel fusion效果变差（每次必须store了）。</p>
<h5 id="attention-的计算与瓶颈">Attention 的计算与瓶颈<a class="headerlink" href="#attention-的计算与瓶颈" title="Permanent link">&para;</a></h5>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Attention is bottlenecked by memory bandwidth</p>
</div>
<figure>
<p><img alt="Alt text" src="../assets/image-7.png" /></p>
</figure>
<p>上图中的N表示sequence length，一般2K，4K等，d表示Transformer中的每个head的输出维度, d = d_model / #head；<strong>一般d &lt;&lt; N</strong>，以GPT-2为例，N = 1024, d = 768/12 = 64</p>
<p>可以观察到，其实Q,K,V,O的大小都不算太大（N * d），但是四个中间结果都是<span class="arithmatex">\(N^2\)</span>的大小，所以序列长度N一大，就会有问题—。</p>
<p>最朴素的实现方式需要重复地对 GPU HBM 进行读写，读写HBM成为主要瓶颈：</p>
<p><img alt="Alt text" src="../assets/image-12.png" /></p>
<p>从下图中可以看到，matmul部分(Compute-bound)其实占用的时间并不多，Dropout, softmax, Mask等(Memory-bound)操作占用了大部分时间：</p>
<figure>
<p><img alt="Alt text" src="../assets/image-9.png" width="300" /></p>
</figure>
<div class="admonition tip">
<p class="admonition-title">相关阅读</p>
<p><a href="https://arxiv.org/pdf/2007.00072.pdf">Data Movement Is All You Need: A Case Study on Optimizing Transformers</a></p>
</div>
<h5 id="approximate-attention">Approximate Attention<a class="headerlink" href="#approximate-attention" title="Permanent link">&para;</a></h5>
<p>之前也有一些工作，为了加快计算速度，不做全量的计算，而是做近似计算，但都没有被大规模采用，毕竟大家还是比较关注于精度的。</p>
<figure>
<p><img alt="Alt text" src="../assets/image-10.png" /></p>
</figure>
<div class="admonition tip">
<p class="admonition-title">相关阅读</p>
<p>可以看一篇综述：<a href="https://arxiv.org/pdf/2011.04006.pdf">Long Range Arena: A Benchmark for Efficient Transformers(ICLR'20)</a></p>
</div>
<h3 id="2-method">2. Method<a class="headerlink" href="#2-method" title="Permanent link">&para;</a></h3>
<p>其实就是最基本的tiling的思路，但是会有一些挑战：</p>
<ul>
<li>
<p>计算softmax的时候，需要一整行一起计算</p>
</li>
<li>
<p>反向传播的时候，需要比较大的中间结果</p>
</li>
</ul>
<p>解决方法：</p>
<ul>
<li>
<p>改进tiling的方式，减少SRAM和HBM之间的数据传输</p>
</li>
<li>
<p>使用经典的Recomputation的方式，不存储中间结果，反向传播需要的时候再冲算一遍</p>
</li>
</ul>
<div class="admonition quesiton">
<p class="admonition-title">Quesiton</p>
<p>实现方式：fused CUDA kernel for fine-grained control pf memory accesses</p>
<p>还不懂是啥</p>
</div>
<h4 id="tiling">Tiling<a class="headerlink" href="#tiling" title="Permanent link">&para;</a></h4>
<p>一个将softmax拆开计算的想法：</p>
<p><span class="arithmatex">\(\operatorname{softmax}\left(\left[A_1, A_2\right]\right)=\left[\alpha \operatorname{softmax}\left(A_1\right), \beta \operatorname{softmax}\left(A_2\right)\right]\)</span></p>
<p><span class="arithmatex">\(\operatorname{softmax}\left(\left[A_1, A_2\right]\right)\left[\begin{array}{l}V_1 \\ V_2\end{array}\right]=\alpha \operatorname{softmax}\left(A_1\right) V_1+\beta \operatorname{softmax}\left(A_2\right) V_2\)</span></p>
<p>所以<span class="arithmatex">\(\alpha\)</span>, <span class="arithmatex">\(\beta\)</span>分别是什么？</p>
<p>这样的话，一个Block的计算流程都可以在SRAM中完成，只需最后再进行一个缩放即可：</p>
<figure>
<p><img alt="Alt text" src="../assets/image-13.png" width="400" /></p>
</figure>
<div class="admonition note">
<p class="admonition-title">更便于理解的动态演示</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:8"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><input id="__tabbed_1_5" name="__tabbed_1" type="radio" /><input id="__tabbed_1_6" name="__tabbed_1" type="radio" /><input id="__tabbed_1_7" name="__tabbed_1" type="radio" /><input id="__tabbed_1_8" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">frame1</label><label for="__tabbed_1_2">frame2</label><label for="__tabbed_1_3">frame3</label><label for="__tabbed_1_4">frame4</label><label for="__tabbed_1_5">frame5</label><label for="__tabbed_1_6">frame6</label><label for="__tabbed_1_7">frame7</label><label for="__tabbed_1_8">frame8</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><figure markdown>
    <img alt="Alt text" src="../assets/image-42.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-43.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-48.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-45.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-41.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-49.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-39.png" />
</figure></p>
</div>
<div class="tabbed-block">
<p><figure markdown>
  <img alt="Alt text" src="../assets/image-38.png" />
</figure></p>
</div>
</div>
</div>
</div>
<h4 id="recomputation">Recomputation<a class="headerlink" href="#recomputation" title="Permanent link">&para;</a></h4>
<p>其实也是借鉴了gradient checkpointing的想法，不过不同的是:</p>
<ul>
<li>
<p>gradient checkpoint 常被认为是在maximum amount of memory required 和 speed 之间的trade off</p>
</li>
<li>
<p>在计算能力足够的情况下，通过更大的FLOPs(floating point operations per second)，recomputation甚至比从HBM中读取更快；比如看下表，多做些计算，少些对HBM的读写，总的Runtime会更短</p>
</li>
</ul>
<figure>
<p><img alt="Alt text" src="../assets/image-25.png" /></p>
</figure>
<h2 id="flashattention-2">FlashAttention-2<a class="headerlink" href="#flashattention-2" title="Permanent link">&para;</a></h2>
<p><a href="https://arxiv.org/pdf/2307.08691.pdf">FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning</a></p>
<p>这篇论文补充了许多FlashAttention的细节，主要是在并行性上做了一些优化，使得计算速度更快。</p>
<h3 id="1-introduction_1">1. Introduction<a class="headerlink" href="#1-introduction_1" title="Permanent link">&para;</a></h3>
<p><strong>Key Insights:</strong></p>
<ul>
<li>
<p>减少 non-matmul FLOPs：GPU对matmul的计算有很好的并行性，但是对于其他的操作，比如softmax，mask，dropout等，就不是那么好了，所以可以考虑减少这些操作的计算量</p>
</li>
<li>
<p>在 seqlen这个维度上做并行，从而提高 occupancy；之前仅仅是在batch size, head层面上做，但实际上batch size， head的数量都不是很大，仅仅在这些维度上做并行，还有部分的GPU core是空闲的。在 warps(32 threads) 的层面上做更好的 work partitioning 。</p>
</li>
</ul>
<p><strong>效果：</strong>
效果使得attention 的计算速度更接近于 pure Matrix Multiplication。</p>
<figure>
<p><img alt="Alt text" src="../assets/image-26.png" /></p>
</figure>
<h3 id="2-method_1">2. Method<a class="headerlink" href="#2-method_1" title="Permanent link">&para;</a></h3>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2023-08-13T07:49:22+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-08-13</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2023-08-13T07:49:22+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-08-13</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.indexes", "navigation.top", "content.code.select", "content.code.copy", "content.code.select", "content.code.annotate", "toc.follow"], "search": "../../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../../../js/timeago.min.js"></script>
        
      
        
          <script src="../../../js/timeago_mkdocs_material.js"></script>
        
      
        
          <script src="../../../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>